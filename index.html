<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="description" content="">-->
    <title>Optimizing Google Analytics Cookies at Illinois | IT Professionals Forum Spring 2025 | University of Illinois Urbana-Champaign</title>
    <link rel="dns-prefetch" href="https://cdn.toolkit.illinois.edu">
    <link rel="icon" href="https://cdn.brand.illinois.edu/favicon.ico">
    <link rel="stylesheet" href="https://cdn.toolkit.illinois.edu/3/toolkit.css">
    <script src="https://cdn.toolkit.illinois.edu/3/toolkit.js"></script>

    <!-- SkipTo link -->
    <link rel="dns-prefetch" href="//cdn.disability.illinois.edu">
    <script src="https://cdn.disability.illinois.edu/skipto.min.js"></script>
    <script>var SkipToConfig = { 'settings': { 'skipTo': { displayOption: 'popup', colorTheme: 'illinois' } } };</script>

    <!-- Toolkit style supplement -->
    <style>
    * {
        box-sizing: border-box;
    }
    body {
        margin: 0px;
    }
    #container {
        max-width: 1250px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 20px;
        margin-bottom: 30px;
        padding: 25px;
    }
    main li {
        margin-top: .35em;
    }
    .slide {
        clear: both;
        float: left;
        margin-bottom: 20px;
        min-width: 100%;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .slide:not(:first-of-type) {
        border-top: 1px solid #ccc;
    }
    .slide h2 {
        margin-top: 0px;
        padding-top: 20px;
    }
    .slide li ul {
        margin-top: 10px;
    }
    .slide .col1 {
        width: 55%;
        float: left;
    }
    .slide .col1 > ul {
        margin-top: 0px;
    }
    .slide .col2 {
        width: calc(45% - 35px);
        margin-left: 35px;
        float: left;
    }
    .slide figure {
        padding: 5px;
        border: 1px solid #ddd;
        margin-top: 10px;
        background: var(--il-storm-lighter-4);
    }
    .slide figcaption {
        font-family: 'Source Sans';
        text-align: center;
        padding: 3px;
    }
    .slide img {
        width: 100%;
        border: 1px solid #ddd;
    }
    .slide code {
        overflow-wrap: anywhere;
    }
    @media (max-width: 900px) {
        .slide .col1, .slide .col2 {
            float: none;
            width: 100%;
            margin-left: 0px;
        }
    }
    ilw-footer {
        margin-top: 40px;
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }
    </style>
</head>

<body>
<ilw-page>
    <ilw-header slot="header">
        <a slot="primary-unit" href="https://itproforum.illinois.edu/">IT Professionals Forum Spring 2025</a>
        <a slot="site-name" href="">Optimizing Google Analytics Cookies at Illinois</a>
        <nav slot="links" aria-label="Utility">
            <ul>
                <li><a href="https://itproforum.illinois.edu/">IT Professionals Forum</a></li>
                <li><a href="https://publish.illinois.edu/analytics/analytics/ga4/">Google Analytics 4 at Illinois</a></li>
            </ul>
        </nav>
    </ilw-header>

    <main class="ilw-content">
    <ilw-content>
    <div id="container">

        <h1 class="sr-only">Optimizing Google Analytics Cookies at Illinois</h1>

        <p style="position: relative; bottom: 20px;">This content was originally presented at a <a href="https://itproforum.illinois.edu/eventdesc/spring-2025/day-2-315-pm/taming-a-cookie-monster-optimizing-google-analytics-cookies-at-illinois/">session at the IT Professionals Forum Spring 2025</a>. <em>Note to the presenter: a slide-like display can be started by adding <a href="?mode=present">?mode=present</a> to the end of the page URL. Set the zoom between 175% and 200% and use the up/down arrow keys to navigate through the slides.</em></p>

        <ilw-accordion>
            <ilw-accordion-panel>
                <h2 slot="summary">Table of Contents</h3>
                <ul>
                    <li><a href="#slide0">Introduction</a></li>
                    <li><a href="#slide1">Google Analytics 4 and Google Tag Manager</a></li>
                    <li><a href="#slide2">Google Analytics 4 Cookies</a></li>
                    <li><a href="#slide3">Cookie Accumulation and Browser Errors</a></li>
                    <li><a href="#slide4">Who Can This Affect?</a></li>
                    <li><a href="#slide5">Possible Solutions</a></li>
                    <li><a href="#slide6">Solution: Clearing Browser Cookies</a></li>
                    <li><a href="#slide7">Solution: Cookie Clean Up Script</a></li>
                    <li><a href="#slide8">Solution: Increasing Max Request Header Size</a></li>
                    <li><a href="#slide9">Solution: Setting the Cookie Domain</a></li>
                    <li><a href="#slide10">Solution: Setting the Cookie Domain (GTM config)</a></li>
                    <li><a href="#slide11">Solution: Setting the Cookie Domain (gtag config)</a></li>
                </ul>
            </ilw-accordion-panel>
        </ilw-accordion>
        
        <div class="slide">
            <h2 id="slide0">Introduction</h2>
            <div class="col1">
                <ul>
                    <li>Topic: <strong>Optimizing Google Analytics Cookies at Illinois</strong>
                        <ul>
                            <li>Addressing 400-level browser errors seen by end users which can prevent website access; in part, caused by an accumulation of cookies used by Google Analytics 4 (GA4)</li>
                            <li><em>Shout out to the <a href="https://umarcomm.umn.edu/blog/2024/01/29/optimizing-cookie-domains-and-cleaning-google-tag-manager-streamlined-umnedu">UMN blog post</a> that helped bring this to our campus' attention</em></li>
                        </ul>
                    </li>
                    <li>Presenter: <strong>Dan Dalpiaz</strong>
                        <ul>
                            <li>Web Developer in the University Library at the University of Illinois Urbana-Champaign</li>
                            <li>Not an expert in Google Analytics itself, but...</li>
                            <li>Have been tracking a particular cookie issue for a while now</li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/ga.png">
                        <img src="images/ga.png" alt="Google Analytics logo">
                    </a>
                    <figcaption>Google Analytics logo</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide1">Google Analytics 4 and Google Tag Manager</h2>
            <ul>
                <li><strong>Google Analytics 4</strong>
                    <ul>
                        <li>Google's latest version of their web analytics service, replaces Universal Analytics (UA).</li>
                        <li>Within the GA4 platform, there are 'Accounts' which contain 'Properties' which contain 'Data Streams'
                            <ul>
                                <li>Typically only one Data Stream is used within a property when used for a website.</li>
                                <li>Creating a Data Stream generates an associated 'Google Tag'. The tag created for a web Data Stream will have two tag IDs: a 'Measurement ID' (e.g. <code>G-5WMFPCS43H</code>) and a 'Tag ID' (e.g. <code>GT-WK5N5G5J</code>).</li>
                                <li>Other Google services can also use Google tags, but GA4 seems to be the most common on our campus.</li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><strong>Google Tag Manager</strong>
                    <ul>
                        <li>Google's tag management system that can be used to manage various tags, including GA4 tags.</li>
                        <li>Not required to use for GA4, but can provide more options for managing tags and tracking.</li>
                    </ul>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide2">Google Analytics 4 Cookies</h2>
            <div class="col1">
                <ul>
                    <li>Google Tags use a <a href="https://en.wikipedia.org/wiki/HTTP_cookie">browser cookie</a> to establish sessions and track  activity.
                        <ul>
                            <li>GA4 tags use cookies with names like: <code>_ga_&lt;TAG-ID&gt;</code>, e.g. <code>_ga_5WMFPCS43H</code></li>
                            <li>Each cookie is usually about 50-100 bytes in size.</li>
                        </ul>
                    </li>
                    <li><strong>By default, GA4 tags will set the cookie's domain as the base ".illinois.edu" domain and not the subdomain for the site in question.</strong> This default behavior is explained in <a href="https://developers.google.com/tag-platform/security/guides/customize-cookies">Google's Tag Platform documentation</a>.
                        <ul>
                            <li>Cookies set with the .illinois.edu domain will be included in the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">request headers</a> for requests made to any subdomain site (example.illinois.edu).</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/cookies.jpg">
                        <img src="images/cookies.jpg" alt="baked cookies">
                    </a>
                    <figcaption>The other, sweeter kind of cookies</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide3">Cookie Accumulation and Browser Errors</h2>
            <div class="col1">
                <ul>
                    <li>Over time, as a user visits more and more campus websites that use Google Analytics, the number of <code>_ga_ cookies</code> can accumulate in their browser.</li>
                    <li>Web servers like Apache and Nginx set a maximum allowable size for the request headers they are sent. The default is typically around 8000 bytes.</li>
                    <li>If enough cookies accumulate in the browser (along with other information sent in request headers), the total size of the request headers can exceed the server's maximum allowable size and will result in a browser error — usually HTTP status code 400 (Bad Request) or 431 (Request Header Fields Too Large).</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/cookie-list-3.png">
                        <img src="images/cookie-list-3.png" alt="screenshot of a list of _ga_ cookies in the browser's developer tools">
                    </a>
                    <figcaption>Example list of cookies in the browser's developer tools</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide4">Who Can This Affect?</h2>
            <div class="col1">
                <ul>
                    <li>No individual user or campus website is completely immune to this issue. If certain conditions are met, any user visiting any website on the illinois.edu domain <em>could</em> run into this problem.
                        <ul>
                            <li>Can happen on websites that aren't running Google Analytics or using any other Google tags</li>
                        </ul>
                    </li>
                    <li>This is most likely to be encountered by users who visit a large number of campus websites and do not clear their browser's cookies on a regular basis.</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/bad-request-2.png">
                        <img src="images/bad-request-2.png" alt="screenshot of a 400 Bad Request error">
                    </a>
                    <figcaption>Example of a 400 Bad Request error in the browser</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide5">Possible Solutions</h2>
            <ul>
                <li><strong>Short-Term</strong>
                    <ul>
                        <li>Clear the user's browser cookies (End User)</li>
                        <li>Implement a cookie clean up script on your website (IT Pro)</li>
                        <li>Increase the maximum allowable size of request headers on the web server (IT Pro)</li>
                    </ul>
                </li>
                <li><strong>Long-Term</strong>
                    <ul>
                        <li>Setting the GA cookie domain to the relevant subdomain
                            <ul>
                                <li>Using Google Tag Manager configuration (GTM User)</li>
                                <li>Using gtag.js configuration (IT Pro)</li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide6">Solution: Clearing Browser Cookies</h2>
            <div class="col1">
                <ul>
                    <li>If a user starts seeing 400/431 errors on one or more campus sites, you can assist them in clearing their browser's cookies. See <a href="https://answers.uillinois.edu/illinois/page.php?id=115654">Browsers, Clearing Cache and Cookies</a>.
                        <ul>
                            <li>This will clear all cookies, not just GA4 cookies. The user will need to reauthenticate with sites that use cookies to manage user sessions.</li>
                            <li>Alternatively, if comfortable with the browser's developer tools, you can assist the user in manually deleting just the <code>_ga_</code> cookies on the .illinois.edu domain.</li>
                        </ul>
                    </li>
                    <li>This is a short-term solution and may need to be repeated if the user continues to visit a large number of campus websites.</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/cookies-clear.png">
                        <img src="images/cookies-clear.png" alt="screenshot of the Chrome browser's delete browsing data dialog">
                    </a>
                    <figcaption>Clearing cookies in the Chrome browser</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide7">Solution: Cookie Clean Up Script</h2>
            <ul>
                <li>It is possible to automatically clear <code>_ga_</code> cookies using JavaScript. Permissions are such that a subdomain site can modify cookies set at the higher level ".illinois.edu" domain.</li>
                <li>A script has been made available on GitHub: <a href="https://github.com/UIUCLibrary/ga-cookie-script">https://github.com/UIUCLibrary/ga-cookie-script</a>. Example usage where the script will clear a user's <code>_ga_</code> cookies if there are more than 20 accumulated:
                    <ul>
                        <li><code>&lt;script src="https://cdn.jsdelivr.net/gh/UIUCLibrary/ga-cookie-script@1.0.0/ga-cookie-script.min.js?max=20"&gt;&lt;/script&gt;</code></li>
                    </ul>
                </li>
                <li>This can be effective when implemented on high traffic pages to 'catch' the most amount of users. For users currently experiencing 400 errors, you could try directing them to a page running the script. </li>
                <li><em>Shout out to the campus web community for suggesting a script like this as a possibility.</em></li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide8">Solution: Increasing Max Request Header Size</h2>
            <ul>
                <li>IT Pros that have access to a site's web server configuration (Apache, Nginx, IIS, etc.) may be able to increase the maximum allowable size of request headers. Note, this will only help prevent user errors for a specific site.
                    <ul>
                        <li>Apache, for example, has the <code>LimitRequestFieldSize</code> directive.</li>
                    </ul>
                </li>
                <li><strong>Should be used cautiously</strong> — allowing larger request headers to be sent to the server could potentially be abused by bad actors.</li>
                <li>This is likely not an option for vended services that use an illinois.edu subdomain, unless the vendor is willing to make this change.</li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide9">Solution: Setting the Cookie Domain</h2>
            <ul>
                <li>The previous solutions have downsides and are best used as a short-term fix. Clearing cookies is often inconvenient and even if done automatically, it will affect the analytics session data (effectively restarting the user session).</li>
                <li><strong>Sites using GA4 have the ability to set the domain for its <code>_ga_</code> cookie to the site's own subdomain.</strong> This would prevent the cookie from being included in requests to other subdomains.</li>
                <li>Technically, this could temporarily makes things worse since this will generate a new cookie with the relevant subdomain, but the original cookie may not expire for some time.</li>
                <li>We'll go over some different ways of explictly setting the cookie's domain, depending on how the analytics were set up.</li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide10">Solution: Setting the Cookie Domain (GTM config)</h2>
            <div class="col1">
                <ul>
                    <li>If you are using Google Tag Manager to manage your GA4 tags, you can set the cookie domain in the tag configuration:
                        <ul>
                            <li>In <a href="https://tagmanager.google.com/">Google Tag Manager</a>, locate the GA4 tag you want to modify.</li>
                            <li>Edit the 'Tag Configuration' and add a new 'Configuration Parameter' with a name of <code>cookie_domain</code> and a value of the site's subdomain, e.g. <code>example.illinois.edu</code>.</li>
                            <li>Save the changes and publish the container.</li>
                        </ul>
                    <li>See <a href="https://developers.google.com/tag-platform/security/guides/customize-cookies#tag-manager">Google's Tag Platform documentation</a> for more information.</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/tag-config.png">
                        <img src="images/tag-config.png" alt="screenshot of the Google Tag Manager tag configuration with cookie_domain parameter">
                    </a>
                    <figcaption>Setting the cookie_domain parameter in Google Tag Manager</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide11">Solution: Setting the Cookie Domain (gtag config)</h2>
            <ul>
                <li>If you are using Google Analytics without Google Tag Manager, configuration can be added to the existing JavaScript snippet:
                    <ul>
                        <li><code>gtag('config', 'TAG_ID', {'cookie_domain': 'example.illinois.edu'});</code></li>
                    </ul>
                </li>
                <li>Alternatively, you could consider using Google Tag Manager to manage the GA4 tag instead. Steps to add an existing GA4 tag to GTM can be found on the <a href="https://support.google.com/tagmanager/answer/9442095?hl=en">Set up Google Analytics in Tag Manager</a> support page. After adding the GA4 tag to GTM and adding the cookie domain configuration as described in the previous slide, you can switch the site to use the GTM snippets instead of the gtag.js snippets.</li>
            </ul>
        </div>

    </div>
    </ilw-content>
    </main>

    <ilw-footer slot='footer'>
        <a slot="primary-unit" href="https://itproforum.illinois.edu/">IT Professionals Forum Spring 2025</a>
        <a slot="site-name" href="">Optimizing Google Analytics Cookies at Illinois</a>
    </ilw-footer>

    <script>
        if (new URLSearchParams(window.location.search).get('mode') === 'present') {
            // set the slide height to the screen height
            document.querySelectorAll('.slide').forEach(function (slide) {
                slide.style.height = '100vh';
            });

            // visually hide the scrollbar
            var style = document.createElement('style');
            style.type = 'text/css';
            style.appendChild(document.createTextNode('body::-webkit-scrollbar {display: none;}'));
            document.head.appendChild(style);

            // arrow down to advance to the next slide
            document.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    var slideNumber = parseInt(window.location.hash.replace('#slide', '')) || 0;
                    slideNumber++;
                    var nextSlide = document.querySelector('#slide' + slideNumber);
                    if (nextSlide) {
                        nextSlide.scrollIntoView();
                        window.history.pushState(null, null, '#slide' + slideNumber);
                    } else {
                        window.location.hash = '#slide1';
                    }

                }
            });

            // arrow up to go back to the previous slide
            document.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    var slideNumber = parseInt(window.location.hash.replace('#slide', '')) || 0;
                    slideNumber--;
                    var prevSlide = document.querySelector('#slide' + slideNumber);
                    if (prevSlide) {
                        prevSlide.scrollIntoView();
                        window.history.pushState(null, null, '#slide' + slideNumber);
                    } else {
                        var lastSlide = document.querySelector('.slide:last-of-type');
                        if (lastSlide) {
                            lastSlide.scrollIntoView();
                            window.history.pushState(null, null, '#slide' + (document.querySelectorAll('.slide').length));
                        }

                    }
                }
            });
        }
    </script>
</ilw-page>
</body>
</html>
