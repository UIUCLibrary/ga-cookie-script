<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="description" content="">-->
    <title>Optimizing Google Analytics Cookies at Illinois | IT Professionals Forum Spring 2025 | University of Illinois Urbana-Champaign</title>
    <link rel="dns-prefetch" href="https://cdn.toolkit.illinois.edu">
    <link rel="icon" href="https://cdn.brand.illinois.edu/favicon.ico">
    <link rel="stylesheet" href="https://cdn.toolkit.illinois.edu/3/toolkit.css">
    <script src="https://cdn.toolkit.illinois.edu/3/toolkit.js"></script>

    <!-- SkipTo link -->
    <link rel="dns-prefetch" href="//cdn.disability.illinois.edu">
    <script src="https://cdn.disability.illinois.edu/skipto.min.js"></script>
    <script>var SkipToConfig = { 'settings': { 'skipTo': { displayOption: 'popup', colorTheme: 'illinois' } } };</script>

    <!-- Toolkit style supplement -->
    <style>
    * {
        box-sizing: border-box;
    }
    body {
        margin: 0px;
    }
    #container {
        max-width: 1250px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 20px;
        margin-bottom: 30px;
        padding: 25px;
    }
    main li {
        margin-top: .35em;
    }
    .slide {
        clear: both;
        float: left;
        margin-bottom: 20px;
        min-width: 100%;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .slide:not(:first-of-type) {
        border-top: 1px solid #ccc;
    }
    .slide h2 {
        margin-top: 0px;
        padding-top: 20px;
    }
    .slide li ul {
        margin-top: 10px;
    }
    .slide .col1 {
        width: 55%;
        float: left;
    }
    .slide .col1 > ul {
        margin-top: 0px;
    }
    .slide .col2 {
        width: calc(45% - 35px);
        margin-left: 35px;
        float: left;
    }
    .slide figure {
        padding: 5px;
        border: 1px solid #ddd;
        margin-top: 5px;
        background: var(--il-storm-lighter-4);
    }
    .slide figcaption {
        font-family: 'Source Sans';
        text-align: center;
    }
    .slide img {
        width: 100%;
        border: 1px solid #ddd;
    }
    @media (max-width: 900px) {
        .slide .col1, .slide .col2 {
            float: none;
            width: 100%;
            margin-left: 0px;
        }
    }
    ilw-footer {
        margin-top: 40px;
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }
    </style>
</head>

<body>
<ilw-page>
    <ilw-header slot="header">
        <a slot="primary-unit" href="https://itproforum.illinois.edu/">IT Professionals Forum Spring 2025</a>
        <a slot="site-name" href="">Optimizing Google Analytics Cookies at Illinois</a>
        <nav slot="links" aria-label="Utility">
            <ul>
                <li><a href="https://itproforum.illinois.edu/">IT Professionals Forum</a></li>
                <li><a href="https://publish.illinois.edu/analytics/analytics/ga4/">Google Analytics 4 at Illinois</a></li>
            </ul>
        </nav>
    </ilw-header>

    <main class="ilw-content">
    <ilw-content>
    <div id="container">

        <h1 class="sr-only">Optimizing Google Analytics Cookies at Illinois</h1>

        <p style="position: relative; bottom: 20px;">This content was originally presented at the <a href="https://itproforum.illinois.edu/">IT Professionals Forum Spring 2025</a>. <em>Note to the presenter: a slide-like display can be started by adding <a href="?mode=present">?mode=present</a> to the end of the page URL. Set the zoom between 175% and 200% and use the up/down arrow keys to navigate through the slides.</em></p>

        <ilw-accordion>
            <ilw-accordion-panel>
                <h2 slot="summary">Table of Contents</h3>
                <ul>
                    <li><a href="#slide1">Slide #1</a></li>
                    <li><a href="#slide2">Slide #2</a></li>
                </ul>
            </ilw-accordion-panel>
        </ilw-accordion>
        
        <div class="slide">
            <h2 id="slide1">Introduction</h2>
            <div class="col1">
                <ul>
                    <li>Topic: <strong>Optimizing Google Analytics Cookies at Illinois</strong>
                        <ul>
                            <li>Addressing 400-level browser errors seen by end users which can prevent website access; in part, caused by an accumulation of cookies used by Google Analytics 4 (GA4)</li>
                        </ul>
                    </li>
                    <li>Presenter: <strong>Dan Dalpiaz</strong>
                        <ul>
                            <li>Web Developer in the University Library at the University of Illinois Urbana-Champaign</li>
                            <li>Not an expert in Google Analytics itself, but...</li>
                            <li>Have been tracking this particular issue for a while now</li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/cookies.jpg">
                        <img src="images/cookies.jpg" alt="baked cookies">
                    </a>
                    <figcaption>The other, sweeter kind of cookies</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide2">Google Analytics 4 Cookies</h2>
            <ul>
                <li>Google Analytics uses a <a href="https://en.wikipedia.org/wiki/HTTP_cookie">browser cookie</a> to establish analytics sessions and track user activity.
                    <ul>
                        <li>GA4 uses cookies with names like: <code>_ga_&lt;TAG-ID&gt;</code>, e.g. <code>_ga_YKXZBYWM4X</code></li>
                        <li>Each cookie is usually between 50-100 bytes in size.</li>
                    </ul>
                </li>
                <li><strong>By default, GA4 will set the cookie's domain as the top-level ".illinois.edu" domain instead of the subdomain for the site in question. Cookies set with the top-level .illinois.edu domain will be included in the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">request headers</a> for requests made to subdomain sites (example.illinois.edu).</strong>
                    <ul>
                        <li>This cookie configuration differs from the previous version of Google Analytics, 'Universal Analytics (UA)'.</li>
                        <li>In theory, cookie domains could automatically be set to the approriate subdomain if all .illinois.edu sites were using a single data stream, but, this is not feasible for a decentralized setup.</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide3">Cookie Accumulation and Browser Errors</h2>
            <div class="col1">
                <ul>
                    <li>Over time, as a user visits more and more campus websites that use Google Analytics, the number of <code>_ga_ cookies</code> can accumulate in their browser.</li>
                    <li>Web servers like Apache and Nginx set a maximum allowable size for the request headers they are sent. The default is typically around 8000 bytes.</li>
                    <li>If enough cookies accumulate in the browser (along with other information sent in request headers), the total size of the request headers can exceed the server's maximum allowable size and will result in a browser error — usually HTTP status code 400 (Bad Request) or 431 (Request Header Fields Too Large).</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/cookie-list-3.png">
                        <img src="images/cookie-list-3.png" alt="screenshot of a list of _ga_ cookies in the browser's developer tools">
                    </a>
                    <figcaption>Example list of cookies in the browser's developer tools</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide4">Who Can This Affect?</h2>
            <div class="col1">
                <ul>
                    <li>No individual user or campus website is completely immune to this issue. If certain conditions are met, any user visiting any website on the illinois.edu domain <em>could</em> run into this problem.
                        <ul>
                            <li>Can happen on websites that aren't running Google Analytics</li>
                        </ul>
                    </li>
                    <li>This is most likely to be encountered by users who visit a large number of campus websites and do not clear their browser's cookies on a regular basis.</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/bad-request-2.png">
                        <img src="images/bad-request-2.png" alt="screenshot of a 400 Bad Request error">
                    </a>
                    <figcaption>Example of a 400 Bad Request error in the browser</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide5">Possible Solutions</h2>
            <ul>
                <li><strong>Short-Term</strong>
                    <ul>
                        <li>Help the user clear their browser's cookies</li>
                        <li>Implement a cookie clean up script on your website</li>
                        <li>Increase the maximum allowable size of request headers on the web server</li>
                    </ul>
                </li>
                <li><strong>Long-Term</strong>
                    <ul>
                        <li>Manually set the GA cookie domain to the appropriate subdomain</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide6">Solution: Clearing Browser Cookies</h2>
            <div class="col1">
                <ul>
                    <li>If a user starts seeing 400/431 errors on one or more campus sites, you can assist them in clearing their browser's cookies. See <a href="https://answers.uillinois.edu/illinois/page.php?id=115654">Browsers, Clearing Cache and Cookies</a>.
                        <ul>
                            <li>This will clear all cookies, not just GA4 cookies. The user will need to reauthenticate with sites that use cookies to manage user sessions.</li>
                            <li>Alternatively, if comfortable with the browser's developer tools, you can assist the user in manually deleting just the <code>_ga_</code> cookies on the .illinois.edu domain.</li>
                        </ul>
                    </li>
                    <li>This is a short-term solution and may need to be repeated if the user continues to visit a large number of campus websites.</li>
                </ul>
            </div>
            <div class="col2">
                <figure>
                    <a href="images/cookies-clear.png">
                        <img src="images/cookies-clear.png" alt="screenshot of the Chrome browser's delete browsing data dialog">
                    </a>
                    <figcaption>Clearing cookies in the Chrome browser</figcaption>
                </figure>
            </div>
        </div>

        <div class="slide">
            <h2 id="slide7">Solution: Cookie Clean Up Script</h2>
            <ul>
                <li>It is possible to automatically clear <code>_ga_</code> cookies using JavaScript. Permissions are such that a subdomain site can modify cookies set at the higher level ".illinois.edu" domain.</li>
                <li>A script has been made available on GitHub: <a href="https://github.com/UIUCLibrary/ga-cookie-script">https://github.com/UIUCLibrary/ga-cookie-script</a>. Example usage where the script will clear a user's <code>_ga_</code> cookies if there are more than 20 accumulated:
                    <ul>
                        <li><code>&lt;script src="https://cdn.jsdelivr.net/gh/UIUCLibrary/ga-cookie-script@1.0.0/ga-cookie-script.min.js?max=20"&gt;&lt;/script&gt;</code></li>
                    </ul>
                </li>
                <li>This can be effective when implemented on high traffic pages to 'catch' the most amount of users. For users currently experiencing 400 errors, you could try directing them to a page running the script. </li>
                <li><em>Shout out to the campus web community for suggesting a script like this as a possibility.</em></li>
            </ul>
        </div>

        <div class="slide">
            <h2 id="slide8">Solution: Increasing Max Request Header Size </h2>
            <ul>
                <li>IT Pros that have access to a site's web server configuration (Apache, Nginx, IIS, etc.) may be able to increase the maximum allowable size of request headers.
                    <ul>
                        <li>Apache, for example, has the <code>LimitRequestFieldSize</code> directive.</li>
                    </ul>
                </li>
                <li><strong>Should be used cautiously</strong> — allowing larger request headers to be sent to the server could potentially be abused by bad actors.</li>
                <li>This is likely not an option for vended services that use an illinois.edu subdomain, unless the vendor is willing to make this change.</li>
            </ul>
        </div>

    </div>
    </ilw-content>
    </main>

    <ilw-footer slot='footer'>
        <a slot="primary-unit" href="https://itproforum.illinois.edu/">IT Professionals Forum Spring 2025</a>
        <a slot="site-name" href="">Optimizing Google Analytics Cookies at Illinois</a>
    </ilw-footer>

    <script>
        if (new URLSearchParams(window.location.search).get('mode') === 'present') {
            // set the slide height to the screen height
            document.querySelectorAll('.slide').forEach(function (slide) {
                slide.style.height = '100vh';
            });

            // visually hide the scrollbar
            var style = document.createElement('style');
            style.type = 'text/css';
            style.appendChild(document.createTextNode('body::-webkit-scrollbar {display: none;}'));
            document.head.appendChild(style);

            // arrow down to advance to the next slide
            document.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    var slideNumber = parseInt(window.location.hash.replace('#slide', '')) || 0;
                    slideNumber++;
                    var nextSlide = document.querySelector('#slide' + slideNumber);
                    if (nextSlide) {
                        nextSlide.scrollIntoView();
                        window.history.pushState(null, null, '#slide' + slideNumber);
                    } else {
                        window.location.hash = '#slide1';
                    }

                }
            });

            // arrow up to go back to the previous slide
            document.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    var slideNumber = parseInt(window.location.hash.replace('#slide', '')) || 0;
                    slideNumber--;
                    var prevSlide = document.querySelector('#slide' + slideNumber);
                    if (prevSlide) {
                        prevSlide.scrollIntoView();
                        window.history.pushState(null, null, '#slide' + slideNumber);
                    } else {
                        var lastSlide = document.querySelector('.slide:last-of-type');
                        if (lastSlide) {
                            lastSlide.scrollIntoView();
                            window.history.pushState(null, null, '#slide' + (document.querySelectorAll('.slide').length));
                        }

                    }
                }
            });
        }
    </script>
</ilw-page>
</body>
</html>
